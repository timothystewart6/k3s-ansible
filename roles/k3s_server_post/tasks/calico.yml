---
- name: Deploy Calico to cluster
  run_once: true
  when: inventory_hostname == groups[group_name_master | default('master')][0]
  block:
    - name: Create manifests directory on first master
      ansible.builtin.file:
        path: /tmp/k3s
        state: directory
        owner: root
        group: root
        mode: "0755"

    # Calico v3.30+ split: CRDs are no longer bundled in tigera-operator.yaml.
    - name: Download Tigera operator CRDs (v3.30+)
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/projectcalico/calico/{{ calico_tag }}/manifests/operator-crds.yaml"
        dest: /tmp/k3s/operator-crds.yaml
        owner: root
        group: root
        mode: "0644"

    - name: Download Tigera operator manifest
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/projectcalico/calico/{{ calico_tag }}/manifests/tigera-operator.yaml"
        dest: /tmp/k3s/tigera-operator.yaml
        owner: root
        group: root
        mode: "0644"

    - name: Copy Calico custom resources manifest to first master
      ansible.builtin.template:
        src: calico.crs.j2
        dest: /tmp/k3s/custom-resources.yaml
        owner: root
        group: root
        mode: "0644"

    - name: Apply Tigera operator CRDs (server-side to avoid annotation size limit)
      ansible.builtin.command:
        cmd: >-
          {{ k3s_kubectl_binary | default('k3s kubectl') }}
          apply --server-side --force-conflicts
          -f /tmp/k3s/operator-crds.yaml
      register: apply_operator_crds
      changed_when: "'configured' in apply_operator_crds.stdout or 'created' in apply_operator_crds.stdout"
      failed_when: apply_operator_crds.rc != 0

    - name: Wait for Tigera operator CRDs to be established
      ansible.builtin.command: >-
        {{ k3s_kubectl_binary | default('k3s kubectl') }} wait
        --for=condition=Established
        --timeout=180s
        crd/{{ item }}
      register: crd_wait
      changed_when: false
      until: crd_wait is succeeded
      retries: 10
      delay: 6
      with_items:
        # These cover the common objects referenced by calico custom-resources.yaml
        - installations.operator.tigera.io
        - apiservers.operator.tigera.io
        - imagesets.operator.tigera.io

    - name: Apply Tigera Operator
      ansible.builtin.command:
        cmd: "{{ k3s_kubectl_binary | default('k3s kubectl') }} apply -f /tmp/k3s/tigera-operator.yaml"
      register: apply_operator
      changed_when: "'configured' in apply_operator.stdout or 'created' in apply_operator.stdout"
      failed_when: apply_operator.rc != 0

    - name: Wait for Tigera Operator deployment to be Available
      ansible.builtin.command: >-
        {{ k3s_kubectl_binary | default('k3s kubectl') }} wait deployment/tigera-operator
        --namespace=tigera-operator
        --for=condition=Available=True
        --timeout=300s
      register: tigera_result
      changed_when: false
      until: tigera_result is succeeded
      retries: 10
      delay: 6

    - name: Apply Calico custom resources
      ansible.builtin.command:
        cmd: "{{ k3s_kubectl_binary | default('k3s kubectl') }} apply -f /tmp/k3s/custom-resources.yaml"
      register: apply_cr
      changed_when: "'configured' in apply_cr.stdout or 'created' in apply_cr.stdout"
      failed_when: apply_cr.rc != 0

    - name: Wait for Calico system resources to be available
      ansible.builtin.command: >-
        {% if item.type == 'daemonset' %}
        {{ k3s_kubectl_binary | default('k3s kubectl') }} wait pods
        --namespace='{{ item.namespace }}'
        --selector={{ item.selector }}
        --for=condition=Ready
        {% else %}
        {{ k3s_kubectl_binary | default('k3s kubectl') }} wait {{ item.type }}/{{ item.name }}
        --namespace='{{ item.namespace }}'
        --for=condition=Available
        {% endif %}
        --timeout=180s
      register: calico_wait
      changed_when: false
      until: calico_wait is succeeded
      retries: 60
      delay: 7
      with_items:
        - { name: calico-typha, type: deployment, namespace: calico-system }
        - { name: calico-kube-controllers, type: deployment, namespace: calico-system }
        - { name: csi-node-driver, type: daemonset, selector: "k8s-app=csi-node-driver", namespace: calico-system }
        - { name: calico-node, type: daemonset, selector: "k8s-app=calico-node", namespace: calico-system }
       # - { name: calico-apiserver, type: deployment, namespace: calico-apiserver }
      loop_control:
        label: "{{ item.type }}/{{ item.name }}"

    - name: Patch Felix configuration for eBPF mode
      ansible.builtin.command:
        cmd: >-
          {{ k3s_kubectl_binary | default('k3s kubectl') }} patch felixconfiguration default
          --type='merge'
          --patch='{"spec": {"bpfKubeProxyIptablesCleanupEnabled": false}}'
      register: patch_result
      changed_when: "'patched' in patch_result.stdout"
      failed_when: patch_result.rc != 0
      when: calico_ebpf | default(false) | bool